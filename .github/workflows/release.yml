name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Infer release tag
        id: release_tag
        run: |
          git fetch --tags
          latest="$(git describe --tags --abbrev=0 2>/dev/null || echo v0.0.0)"
          if [[ "$latest" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            next="v${major}.${minor}.$((patch + 1))"
          else
            next="${latest}-1"
          fi
          echo "tag=$next" >> "$GITHUB_OUTPUT"

      - name: Build PDF and publish release
        uses: mauforonda/datapackage_quarto_release@main
        with:
          tag: ${{ steps.release_tag.outputs.tag }}
          release_name: ${{ steps.release_tag.outputs.tag }}
          datapackage_path: datapackage.json
          data_paths: |
            ine_ipc_nacional.csv
            ine_ipc_nacional.xlsx
            ine_ipc_producto_ciudad.csv
            ine_ipc_producto_ciudad.xlsx
          qmd_output: datapackage.qmd
          pdf_output: ficha.pdf
          identity: "mefp"
          project: "Monitor de la Recuperación Económica"
